<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../../../../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="../../../../../bower_components/iron-validator-behavior/iron-validator-behavior.html">

<link rel="import" href="../../../validators/password-validator.html">
<link rel="import" href="../../../validators/username-validator.html">

<link rel="import" href="auth-login.style.html">
<link rel="import" href="../../../state/redux-mixin.html">


<dom-module id="login-form">
    <template>
        <style include="login-form-styles"></style>

        <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
        <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>

        <password-validator
                is-valid="{{ispasswordvalid}}"
                validator-name="password-validator"
                id="password-validator"
                error-message={{passwordErrorMessage}} >
        </password-validator>

        <username-validator
                is-valid="{{isusernamevalid}}"
                validator-name="username-validator"
                id="username-validator"
                error-message={{usernameErrorMessage}} >
        </username-validator>

        <div class="auth-form">
            <form>
                <h1>Login</h1>

                <div class="auth-form__action">
                    <paper-input auto-validate
                            id="input_username"
                            validator="username-validator"
                            value={{username}}
                            error-message=[[usernameErrorMessage]]
                            label="Enter Username">
                        <iron-icon icon="mail" slot="prefix"></iron-icon>
                        <div slot="suffix">@email.com</div>
                    </paper-input>
                </div>

                <div class="auth-form__action">

                    <paper-input auto-validate
                                 id="input_password"
                                 type="password"
                                 validator="password-validator"
                                 label="Enter password"
                                 value={{password}}
                                 valid={{ispasswordvalid}}
                                 error-message=[[passwordErrorMessage]]>
                    </paper-input>

                </div>

                <div class="auth-form__action">
                    <button  type="button" on-click="_login"  disabled$="[[!formvalid]]">
                        Login
                    </button>

                </div>

            </form>
        </div>
    </template>

    <script>
        class AuthLoginForm extends App.ReduxMixin(Polymer.Element) {
            static get is() { return 'login-form'; }

            static get properties() {
                return {
                    storedUser: Object,
                    data: {
                        type: Object,
                        value: {}
                    },
                    formvalid: {
                        type: Boolean,
                        value: false
                    },
                    username: {
                        type: String
                    },
                    password: {
                        type: String
                    },
                    ispasswordvalid: {
                        observer: '_validationChanged'
                    },
                    isusernamevalid: {
                        observer: '_validationChanged'
                    }
                }
            }

            constructor() {
                super();
            }

            attached() {
                super.attached();
                console.log('attached');
            }

            _login() {
                this.storedUser = {
                    loggedin: true
                };

               window.history.pushState({}, null, '/meals');
               window.dispatchEvent(new CustomEvent('location-changed'));
            }

            _validationChanged(value) {
                this.formvalid = (this.ispasswordvalid || false) && (this.isusernamevalid || false);
            }


        }

        window.customElements.define(AuthLoginForm.is, AuthLoginForm);
    </script>
</dom-module>