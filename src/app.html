<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="./components/app/app-header/app-header.html">;
<link rel="import" href="./components/app/app-nav/app-nav.html">;
<link rel="import" href="./components/app/app-not-found/app-not-found.html">;
<link rel="import" href="./components/health/meals/meals-list.html">;
<link rel="import" href="./components/health/workouts/workouts-list.html">;
<link rel="import" href="./components/health/schedule/schedule-list.html">;
<link rel="import" href="./components/auth/auth-login/auth-login.html">;

<link rel="import" href="./state/redux-mixin.html">


<dom-module id="polymer-health-app">
    <template>
        <style>
              :host {
                width: 100%;
              }
              .wrapper {
                max-width: 800px;
                width: 96%;
                margin: 0 auto;
              }
        </style>

        <app-location route="{{route}}"></app-location>

        <app-route
                route="{{route}}"
                pattern="[[rootPath]]:page"
                data="{{routeData}}"
                tail="{{subroute}}">
        </app-route>

        <iron-localstorage
                name="user-storage"
                value="{{storedUser}}"
                on-iron-localstorage-load="handleLocalstorageLoadEvent"
                on-iron-localstorage-load-empty="initLocalstorageLoadEvent">
        </iron-localstorage>

        <div>
            <app-header></app-header>
            <app-nav></app-nav>

            <div class="wrapper">
                <iron-pages selected="[[routeData.page]]" attr-for-selected="name" fallback-selection="404">
                    <login-form name="login" route="{{subroute}}"></login-form>

                    <meals-list name="meals" route="{{subroute}}"></meals-list>
                    <workouts-list name="workouts" route="{{subroute}}"></workouts-list>
                    <schedule-list name="schedule" route="{{subroute}}"></schedule-list>

                    <app-not-found name="404"></app-not-found>
                </iron-pages>
            </div>

        </div>
    </template>

    <script>
        Polymer.setPassiveTouchGestures(true);

        class PolymerHealthApp extends App.ReduxMixin(Polymer.Element) {
            static get is() { return 'polymer-health-app'; }

            static get properties() {
                return {
                    name: {
                        type: String
                    },
                    activemenu: {
						type: Array,
						statePath: 'app_menu.selectedmenuitem',
                        observer: '_menuItemChanged'
					},
                    page: {
                        type: String,
                        reflectToAttribute: true,
                    },
                    routeData: Object,
                    subroute: Object,
                    rootPath: String,
                    storedUser: Object
                }
            }

            constructor() {
                super();
                this.name = 'test123';
            }


            static get observers() {
                return [
                    '_routePageChanged(routeData.page)',
                ];
            }

            initLocalstorageLoadEvent() {
                this.storedUser = {
                    loggedin: false
                };
                this.set('route.path', '/login/');
            }

            handleLocalstorageLoadEvent() {
                if (!this.storedUser.loggedin) {
                    this.set('route.path', '/login/');
                }
            }


            _routePageChanged(page) {

                window.history.pushState({}, null, '/' + page);
                window.dispatchEvent(new CustomEvent('location-changed'));
            }

            _menuItemChanged(args) {
                this.set('route.path', '/' + args.value + '/');
            }

        }

        window.customElements.define(PolymerHealthApp.is, PolymerHealthApp);
    </script>
</dom-module>
